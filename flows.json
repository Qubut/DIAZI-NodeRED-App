[
    {
        "id": "1a7f55c947897d20",
        "type": "tab",
        "label": "Activities processing",
        "disabled": false,
        "info": "This flow processes the acitivities\nextracted from the json Object and\nthe sends them through a POST req.\nto IFOX",
        "env": []
    },
    {
        "id": "5813698dd43a8415",
        "type": "subflow",
        "name": "Angular App",
        "info": "",
        "category": "",
        "in": [],
        "out": [
            {
                "x": 780,
                "y": 160,
                "wires": [
                    {
                        "id": "82ad7d75aed5f097",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "f5bc973247a5d1ae",
        "type": "subflow",
        "name": "MQTT",
        "info": "",
        "category": "",
        "in": [],
        "out": [
            {
                "x": 640,
                "y": 400,
                "wires": [
                    {
                        "id": "94b296b07db386a2",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "eee073b556a5c002",
        "type": "mqtt-broker",
        "name": "",
        "broker": "localhost",
        "port": "1883",
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "5",
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "254bec667f96d88f",
        "type": "http in",
        "z": "5813698dd43a8415",
        "name": "authentication",
        "url": "/authentication",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 210,
        "y": 160,
        "wires": [
            [
                "f113ec7b0c20439f",
                "914609fdf5f39b4d"
            ]
        ]
    },
    {
        "id": "ce1682cdb5a27fe8",
        "type": "http in",
        "z": "5813698dd43a8415",
        "name": "data",
        "url": "/data",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 200,
        "wires": [
            [
                "4038b19243f2e6e8",
                "b6b8991c50788cbf"
            ]
        ]
    },
    {
        "id": "4038b19243f2e6e8",
        "type": "function",
        "z": "5813698dd43a8415",
        "name": "Add topic",
        "func": "msg.topic = 'data'\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 200,
        "wires": [
            [
                "61e9f69133439a27",
                "82ad7d75aed5f097"
            ]
        ]
    },
    {
        "id": "f113ec7b0c20439f",
        "type": "function",
        "z": "5813698dd43a8415",
        "name": "Add topic",
        "func": "msg.topic = 'authorization'\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 120,
        "wires": [
            [
                "61e9f69133439a27",
                "82ad7d75aed5f097"
            ]
        ]
    },
    {
        "id": "61e9f69133439a27",
        "type": "debug",
        "z": "5813698dd43a8415",
        "name": "debug 6",
        "active": true,
        "tosidebar": true,
        "console": true,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "counter",
        "x": 685,
        "y": 280,
        "wires": [],
        "l": false
    },
    {
        "id": "914609fdf5f39b4d",
        "type": "http response",
        "z": "5813698dd43a8415",
        "name": "response",
        "statusCode": "200",
        "headers": {},
        "x": 420,
        "y": 160,
        "wires": []
    },
    {
        "id": "b6b8991c50788cbf",
        "type": "http response",
        "z": "5813698dd43a8415",
        "name": "response",
        "statusCode": "200",
        "headers": {},
        "x": 420,
        "y": 240,
        "wires": []
    },
    {
        "id": "82ad7d75aed5f097",
        "type": "join",
        "z": "5813698dd43a8415",
        "name": "",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": true,
        "timeout": "",
        "count": "",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 650,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "88359554b30b8162",
        "type": "join",
        "z": "f5bc973247a5d1ae",
        "name": "",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": true,
        "timeout": "",
        "count": "2",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 450,
        "y": 260,
        "wires": [
            [
                "94b296b07db386a2"
            ]
        ]
    },
    {
        "id": "82697f3394676093",
        "type": "mqtt in",
        "z": "f5bc973247a5d1ae",
        "name": "",
        "topic": "/file/json",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "eee073b556a5c002",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 200,
        "y": 140,
        "wires": [
            [
                "b4ef33cf061ae806",
                "88359554b30b8162"
            ]
        ]
    },
    {
        "id": "ccd157a130533489",
        "type": "mqtt in",
        "z": "f5bc973247a5d1ae",
        "name": "token",
        "topic": "/authentication/token",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "eee073b556a5c002",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 210,
        "y": 260,
        "wires": [
            [
                "88359554b30b8162",
                "66095d4e8972f7c8"
            ]
        ]
    },
    {
        "id": "94b296b07db386a2",
        "type": "function",
        "z": "f5bc973247a5d1ae",
        "name": "processing",
        "func": "\nconst payload = msg.payload\nconst BASEDATE = '2023-07-18T22:00:00.000Z';\n/**\n * Formats a date by adding a specified amount of time (in seconds) \n * to a base date and returns the result in the format 'YYYY-MM-DD HH:MM:SS.SSSSSS'.\n *\n * @param {string} baseDate - The base date in ISO format.\n * @param {number} time - The time in seconds to add to the base date.\n * @return {string} - Formatted date string.\n */\nfunction formatDate(time,baseDate=BASEDATE) {\n  \n    const date = new Date(baseDate);\n    const seconds = Math.floor(time);\n    const microseconds = Math.round((time - seconds) * 1e6);\n    date.setSeconds(seconds);\n    date.setMilliseconds(microseconds / 1000);\n\n    // Format the microseconds to ensure it always has 6 digits\n    const formattedMicroseconds = microseconds.toString().padStart(6, '0');\n    const isoString = date.toISOString().slice(0, -1);\n\n    // the desired format \"YYYY-MM-DD HH:MM:SS.SSSSSS\"\n    const formattedDate = `${isoString.slice(0, 10)} ${isoString.slice(11, 19)}.${formattedMicroseconds}`;\n\n    return formattedDate;\n}\n\n\n\nif (payload.hasOwnProperty('activities') &&\n    Array.isArray(payload.activities) &&\n    payload.activities.length > 0) {\n    const activities = payload.activities\n    msg.payload = activities\n    return msg\n}\nelse if (payload.hasOwnProperty('Resources') &&\n    payload.Resources.length > 0 &&\n    payload.Resources[0].hasOwnProperty('Activities') &&\n    Array.isArray(payload.Resources[0].Activities)) {\n    msg.payload = payload.Resources.flatMap((resource) => {\n\n        return resource.Activities.map((activity) => {\n            return {\n                start: formatDate(activity.StartTime),\n                end: formatDate(activity.EndTime),\n                externProductId: \"\",\n                externResourceIdPerson: resource.DisplayName,\n                externProcessId: (activity.State == 'Idle') ? 'Idle' : 'Busy',\n                reason: \"commend\"\n\n            }\n        })\n    })\n}\nelse {\n    throw new Error('invalid format')\n}\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "bffa4a8a4180f09d",
        "type": "mqtt out",
        "z": "f5bc973247a5d1ae",
        "name": "",
        "topic": "/file/received",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "eee073b556a5c002",
        "x": 710,
        "y": 80,
        "wires": []
    },
    {
        "id": "b4ef33cf061ae806",
        "type": "function",
        "z": "f5bc973247a5d1ae",
        "name": "set payload",
        "func": "msg.payload = {received:true}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 80,
        "wires": [
            [
                "bffa4a8a4180f09d"
            ]
        ]
    },
    {
        "id": "2e1b6ab97340458a",
        "type": "mqtt out",
        "z": "f5bc973247a5d1ae",
        "name": "",
        "topic": "/token/received",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "eee073b556a5c002",
        "x": 720,
        "y": 140,
        "wires": []
    },
    {
        "id": "66095d4e8972f7c8",
        "type": "function",
        "z": "f5bc973247a5d1ae",
        "name": "set payload",
        "func": "msg.payload = {received:true}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 140,
        "wires": [
            [
                "2e1b6ab97340458a"
            ]
        ]
    },
    {
        "id": "388d0dacf92d87b5",
        "type": "http request",
        "z": "1a7f55c947897d20",
        "name": "",
        "method": "POST",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "https://haw.ifox-systems.de/api/v1/extern/Activities/add",
        "tls": "",
        "persist": true,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1030,
        "y": 340,
        "wires": [
            [
                "58ae7552dd7cd450",
                "bd7acd6ac9f5bb0f"
            ]
        ]
    },
    {
        "id": "9badb57c66753082",
        "type": "split",
        "z": "1a7f55c947897d20",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 850,
        "y": 340,
        "wires": [
            [
                "388d0dacf92d87b5"
            ]
        ]
    },
    {
        "id": "bd7acd6ac9f5bb0f",
        "type": "debug",
        "z": "1a7f55c947897d20",
        "name": "debug 5",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "counter",
        "x": 1225,
        "y": 420,
        "wires": [],
        "l": false
    },
    {
        "id": "e452e9fa71839f68",
        "type": "catch",
        "z": "1a7f55c947897d20",
        "name": "",
        "scope": [
            "94b296b07db386a2"
        ],
        "uncaught": false,
        "x": 570,
        "y": 240,
        "wires": [
            [
                "b1bbbf5d8e979d23"
            ]
        ]
    },
    {
        "id": "b1bbbf5d8e979d23",
        "type": "function",
        "z": "1a7f55c947897d20",
        "name": "reject",
        "func": "msg.payload = {accepted:false}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 240,
        "wires": [
            [
                "e81704b7c27c4dd0"
            ]
        ]
    },
    {
        "id": "b76921599904f5c6",
        "type": "complete",
        "z": "1a7f55c947897d20",
        "name": "",
        "scope": [
            "9badb57c66753082"
        ],
        "uncaught": false,
        "x": 590,
        "y": 180,
        "wires": [
            [
                "a3e5711bc826d3e2"
            ]
        ]
    },
    {
        "id": "e81704b7c27c4dd0",
        "type": "mqtt out",
        "z": "1a7f55c947897d20",
        "name": "",
        "topic": "/file/accepted",
        "qos": "2",
        "retain": "true",
        "respTopic": "",
        "contentType": "application/json",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "eee073b556a5c002",
        "x": 950,
        "y": 220,
        "wires": []
    },
    {
        "id": "a3e5711bc826d3e2",
        "type": "function",
        "z": "1a7f55c947897d20",
        "name": "accept",
        "func": "msg.payload = {accepted:true}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 180,
        "wires": [
            [
                "e81704b7c27c4dd0"
            ]
        ]
    },
    {
        "id": "58ae7552dd7cd450",
        "type": "mqtt out",
        "z": "1a7f55c947897d20",
        "name": "",
        "topic": "/api/status",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "eee073b556a5c002",
        "x": 1270,
        "y": 340,
        "wires": []
    },
    {
        "id": "ab9b75f5543399dd",
        "type": "function",
        "z": "1a7f55c947897d20",
        "name": "add authorization header",
        "func": "msg.headers = {\n\n    'Authorization': \"Bearer \" + msg.payload[\"/authentication/token\"],\n    'Content-Type': 'application/json'\n\n}\nmsg.payload = msg.payload[\"/file/json\"]\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 340,
        "wires": [
            [
                "9badb57c66753082"
            ]
        ]
    },
    {
        "id": "2f50741f1ee5f07a",
        "type": "subflow:5813698dd43a8415",
        "z": "1a7f55c947897d20",
        "name": "Angular App",
        "x": 350,
        "y": 380,
        "wires": [
            [
                "ab9b75f5543399dd"
            ]
        ]
    },
    {
        "id": "b4ecd4c3e7167b8b",
        "type": "subflow:f5bc973247a5d1ae",
        "z": "1a7f55c947897d20",
        "name": "MQTT",
        "x": 330,
        "y": 300,
        "wires": [
            [
                "ab9b75f5543399dd"
            ]
        ]
    }
]